service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false; // Prevent deletion
      
      // Validate data structure
      function isValidUser() {
        let user = request.resource.data;
        return 
          user.uid is string &&
          user.firstName is string &&
          user.lastName is string &&
          user.email is string &&
          user.displayName is string &&
          (user.phone == null || user.phone is string) &&
          (user.dateOfBirth == null || user.dateOfBirth is string) &&
          (user.address == null || (
            user.address.street is string &&
            user.address.city is string &&
            user.address.state is string &&
            user.address.zipCode is string &&
            user.address.country is string
          )) &&
          user.preferences.notifications is bool &&
          user.preferences.language is string;
      }
    }
  }
}